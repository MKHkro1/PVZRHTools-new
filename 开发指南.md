# PVZRHTools 项目结构与修改指南

## 项目概述

PVZRHTools 是一个用于《植物大战僵尸：融合版》的修改器工具，由三个子项目组成：
- **ToolModData** - 数据定义层（共享数据结构）
- **ToolModBepInEx** - 游戏插件层（BepInEx 插件，运行在游戏进程中）
- **PVZRHTools** - 修改器界面层（WPF 桌面应用，独立进程）

两个进程通过 Socket 通信进行数据同步。

---

## 项目结构

```
PVZRHTools/
├── .release/                    # 发布输出目录
│   ├── BepInEx/plugins/         # BepInEx 插件 DLL
│   └── PVZRHTools/              # 修改器 EXE 及依赖
├── ToolModData/                 # 数据定义项目 (net6.0)
│   ├── DataDef.cs               # 数据结构定义
│   └── ToolModData.csproj
├── ToolModBepInEx/              # BepInEx 插件项目 (net6.0)
│   ├── Core.cs                  # 插件入口点
│   ├── DataProcessor.cs         # 数据处理（接收修改器指令）
│   ├── DataSync.cs              # Socket 通信
│   ├── PatchMgr.cs              # Harmony 补丁管理（核心功能实现）
│   └── ToolModBepInEx.csproj
├── PVZRHTools/                  # WPF 修改器项目 (net8.0-windows)
│   ├── App.xaml(.cs)            # 应用入口
│   ├── MainWindow.xaml(.cs)     # 主窗口 UI
│   ├── ModifierViewModel.cs     # ViewModel（数据绑定）
│   ├── DataSync.cs              # Socket 通信
│   ├── Lang.zh-cn.xaml          # 中文语言文件
│   ├── Lang.en-us.xaml          # 英文语言文件
│   ├── Lang.ru-ru.xaml          # 俄语语言文件
│   └── PVZRHTools.csproj
├── build_release.ps1            # 构建脚本
└── PVZRHTools.sln               # 解决方案文件
```

---

## 添加新功能的完整流程

以添加一个布尔开关功能为例（如"砸罐子修复"）：

### 步骤 1：定义数据结构 (ToolModData/DataDef.cs)

在 `BasicProperties` 结构体中添加新属性：

```csharp
[Serializable]
public struct BasicProperties : ISyncData
{
    // ... 现有属性 ...
    public bool? PotSmashingFix { get; set; }  // 新增
}
```

### 步骤 2：添加静态开关变量 (ToolModBepInEx/PatchMgr.cs)

在 `PatchMgr` 类中添加静态属性：

```csharp
public class PatchMgr : MonoBehaviour
{
    // ... 现有属性 ...
    public static bool PotSmashingFix { get; set; } = false;  // 新增
}
```

### 步骤 3：实现 Harmony 补丁 (ToolModBepInEx/PatchMgr.cs)

在文件中添加补丁类：

```csharp
#region PotSmashingFix - 功能描述

/// <summary>
/// 功能说明
/// </summary>
[HarmonyPatch(typeof(TargetClass))]
public static class MyFeaturePatches
{
    [HarmonyPrefix]
    [HarmonyPatch(nameof(TargetClass.TargetMethod))]
    public static bool Prefix_TargetMethod(TargetClass __instance)
    {
        if (!PotSmashingFix) return true;  // 开关检查
        
        // 实现逻辑
        return false; // false=跳过原方法, true=继续执行
    }
}

#endregion
```

### 步骤 4：处理数据同步 (ToolModBepInEx/DataProcessor.cs)

在 `ProcessData<T>` 方法的 `BasicProperties` 处理块中添加：

```csharp
if (data is BasicProperties p1)
{
    // ... 现有处理 ...
    if (p1.PotSmashingFix is not null) PotSmashingFix = (bool)p1.PotSmashingFix;
    return;
}
```

### 步骤 5：添加 ViewModel 属性 (PVZRHTools/ModifierViewModel.cs)

添加可观察属性：

```csharp
[ObservableProperty] public partial bool PotSmashingFix { get; set; }
```

添加属性变化处理方法：

```csharp
partial void OnPotSmashingFixChanged(bool value)
{
    App.DataSync.Value.SendData(new BasicProperties { PotSmashingFix = value });
}
```

### 步骤 6：添加 UI 控件 (PVZRHTools/MainWindow.xaml)

在合适的位置添加 CheckBox：

```xml
<CheckBox x:Name="PotSmashingFix" 
          IsChecked="{Binding PotSmashingFix}"
          Content="{DynamicResource Tab1.Page5.PotSmashingFix}" 
          Height="21"
          Margin="10,60,10,0" 
          VerticalAlignment="Top" 
          Foreground="#FF333333"
          BorderThickness="2,2,2,2" 
          HorizontalAlignment="Left"
          ToolTip="{DynamicResource Tab1.Page5.PotSmashingFix.Tooltip}" />
```

### 步骤 7：添加多语言支持

**Lang.zh-cn.xaml:**
```xml
<s:String x:Key="Tab1.Page5.PotSmashingFix">砸罐子修复</s:String>
<s:String x:Key="Tab1.Page5.PotSmashingFix.Tooltip">功能说明</s:String>
```

**Lang.en-us.xaml:**
```xml
<s:String x:Key="Tab1.Page5.PotSmashingFix">PotSmashingFix</s:String>
<s:String x:Key="Tab1.Page5.PotSmashingFix.Tooltip">Feature description</s:String>
```

**Lang.ru-ru.xaml:**
```xml
<s:String x:Key="Tab1.Page5.PotSmashingFix">Исправление</s:String>
<s:String x:Key="Tab1.Page5.PotSmashingFix.Tooltip">Описание</s:String>
```

---

## 构建与发布

### 使用构建脚本（推荐）

运行构建脚本自动构建并输出到 `.release` 目录：

```powershell
powershell -ExecutionPolicy Bypass -File build_release.ps1
```

### 手动构建

```powershell
dotnet build PVZRHTools.sln -c Release
```

### 输出目录结构

构建完成后，文件自动复制到 `.release` 目录：

```
.release/
├── BepInEx/
│   ├── config/                  # BepInEx 配置
│   ├── core/                    # BepInEx 核心文件
│   ├── interop/                 # Il2Cpp 互操作文件
│   ├── plugins/                 # 插件目录（构建输出）
│   │   ├── ToolModBepInEx.dll   # ← 游戏插件主文件
│   │   └── ToolModData.dll      # ← 共享数据定义
│   └── unity-libs/              # Unity 库文件
├── dotnet/                      # .NET 运行时
├── PVZRHTools/                  # 修改器目录（构建输出）
│   ├── PVZRHTools.exe           # ← 修改器主程序
│   ├── PVZRHTools.dll           # ← 修改器程序集
│   ├── PVZRHTools.deps.json     # 依赖配置
│   ├── PVZRHTools.runtimeconfig.json
│   ├── ToolModData.dll          # 共享数据定义
│   ├── CommunityToolkit.Mvvm.dll
│   ├── FastHotKeyForWPF.dll
│   ├── HandyControl.dll         # UI 控件库
│   ├── Microsoft.Extensions.DependencyInjection.dll
│   ├── Microsoft.Extensions.DependencyInjection.Abstractions.dll
│   ├── System.CodeDom.dll
│   ├── System.Management.dll
│   └── runtimes/                # 平台特定运行时
├── doorstop_config.ini          # Doorstop 配置
├── winhttp.dll                  # Doorstop 代理 DLL
└── .doorstop_version            # Doorstop 版本标记
```

### 构建脚本说明 (build_release.ps1)

构建脚本执行以下操作：

1. **构建解决方案** - `dotnet build PVZRHTools.sln -c Release`
2. **复制 BepInEx 插件** - 将 `ToolModBepInEx.dll` 和 `ToolModData.dll` 复制到 `.release/BepInEx/plugins/`
3. **复制修改器文件** - 将 `PVZRHTools.exe` 及所有依赖复制到 `.release/PVZRHTools/`

### 安装到游戏

将 `.release` 目录下的所有内容复制到游戏根目录即可：

```
游戏目录/
├── BepInEx/                     # ← 从 .release 复制
├── PVZRHTools/                  # ← 从 .release 复制
├── doorstop_config.ini          # ← 从 .release 复制
├── winhttp.dll                  # ← 从 .release 复制
├── PlantsVsZombiesRH.exe        # 游戏主程序
└── ...
```

---

## 数据同步机制

```
┌─────────────────┐     Socket      ┌─────────────────┐
│   PVZRHTools    │ ◄────────────► │  ToolModBepInEx │
│   (修改器 UI)    │    JSON 数据    │   (游戏插件)     │
└─────────────────┘                 └─────────────────┘
        │                                   │
        ▼                                   ▼
  ModifierViewModel                    PatchMgr
  (属性变化触发发送)                  (静态变量控制补丁)
```

1. 用户在 UI 操作 → ViewModel 属性变化
2. `OnXxxChanged` 方法发送 `BasicProperties` 数据
3. 游戏端 `DataProcessor` 接收并更新 `PatchMgr` 静态变量
4. Harmony 补丁根据静态变量决定是否生效

---

## 常用 Harmony 补丁模式

### Prefix（前置补丁）
```csharp
[HarmonyPrefix]
[HarmonyPatch(typeof(Board), nameof(Board.GetSun))]
public static bool Prefix(Board __instance, int count)
{
    if (!MyFeature) return true;  // 返回 true 继续执行原方法
    // 自定义逻辑
    return false;  // 返回 false 跳过原方法
}
```

### Postfix（后置补丁）
```csharp
[HarmonyPostfix]
[HarmonyPatch(typeof(Board), nameof(Board.Update))]
public static void Postfix(Board __instance)
{
    if (!MyFeature) return;
    // 在原方法执行后运行
}
```

### 修改返回值
```csharp
[HarmonyPostfix]
public static void Postfix(ref int __result)
{
    if (MyFeature) __result = 0;  // 修改返回值
}
```

---

## 注意事项

1. **开关检查**：所有补丁方法开头必须检查开关状态，关闭时返回 `true` 执行原方法
2. **异常处理**：补丁方法中使用 `try-catch` 防止游戏崩溃
3. **性能考虑**：高频调用的方法（如 Update）中避免复杂逻辑
4. **Il2Cpp 兼容**：使用 `TryCast<T>()` 进行类型转换
5. **空值检查**：访问游戏对象前检查 `null`

---

## 已集成的功能模块

| 功能 | 开关变量 | 说明 |
|------|----------|------|
| PotSmashingFix | `PotSmashingFix` | 砸罐子修复（重叠罐子、AOE保护） |
| UnlimitedSunlight | `UnlimitedSunlight` | 阳光无上限（取消50000上限） |
| MagnetNutUnlimited | `MagnetNutUnlimited` | 磁力坚果无限吸引子弹 |
| DisableIceEffect | `DisableIceEffect` | 取消冰冻特效 |
| ... | ... | 更多功能见 PatchMgr.cs |
